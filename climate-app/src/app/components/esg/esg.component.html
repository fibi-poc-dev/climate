<div class="tab-data-container">


  <p-toolbar>
    <div class="p-toolbar-group-start">
      <ng-content select="[slot=toolbar-start]"></ng-content>
    </div>
    <div class="p-toolbar-group-end" style="display: flex; gap: 10px">
      <p-button [label]="'עדכן (' + esgMainReportRowsChanged().length + ')'" icon="pi pi-save" severity="success" size="small"
        (onClick)="saveClimateData()" [loading]="isSaving()">
      </p-button>
      <p-button label="סנן" icon="pi pi-filter" severity="success" size="small"
        (onClick)="dataService.refreshClimateData()">
      </p-button>
    </div>
  </p-toolbar>





  <!-- Project Construction Financing -->
  <p-panel header="דוח ESG ראשי" class="p-panel-sm" [toggleable]="true" collapsed="false">
    <p-table [value]="esgMainReportRows()" dataKey="account" [paginator]="true" [rows]="10"
      styleClass="p-datatable-striped p-datatable-sm" showGridlines>

      <ng-template pTemplate="caption">
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <!-- Active Filters Display -->
            <div style="display: flex; gap: 0.5rem;">
              @for (filter of esgFilters(); track filter.filterFieldName) {
              <p-chip label="{{ filter.displayName }} {{ filter.filterType }} {{ filter.filterFieldValue }}"
                [removable]="true" (onRemove)="removeEsgFilter(filter.filterFieldName)" />
              }
            </div>
            <p-chip label="{{ esgMainReportRows().length }} רשומות" />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th></th>
          <th>
            <app-filter-field [fieldName]="'bank'" [displayName]="'בנק'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'branch'" [displayName]="'סניף'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'accountType'" [displayName]="'סוג חשבון'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'account'" [displayName]="'חשבון'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'accountName'" [displayName]="'שם לקוח'" [filterType]="'text'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'branchClassificationCode'" [displayName]="'קוד סיווג ענפי'"
              [filterType]="'integer'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'branchClassificatonDescription'" [displayName]="'תיאור סיווג ענפי'"
              [filterType]="'text'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'creditReportDescription'" [displayName]="'תיאור בדוח אשראי'"
              [filterType]="'text'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'currentCreditAuthority'" [displayName]="'סמכות אשראי נוכחית'"
              [filterType]="'numeric'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'handlingUnitCode'" [displayName]="'יחידה מטפלת'" [filterType]="'text'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'regualatedSectorDescription'" [displayName]="'תיאור קוד מגזר פיקוחי'"
              [filterType]="'text'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'creditBalanceSheetRisk'"
              [displayName]="'סיכון אשראי מאזני באש&quot;ח, ללא משכנתאות'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'creditOffBalanceSheetRisk'"
              [displayName]="'סיכון אשראי חוץ מאזני באש&quot;ח, ללא משכנתאות'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalCreditRisk'"
              [displayName]="'סה&quot;כ סיכון אשראי באש&quot;ח, ללא משכנתאות'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'companyType'" [displayName]="'חברה פרטית/ ציבורית'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'companyNumber'" [displayName]="'שווי חברה ציבורית'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'companyName'" [displayName]="'שם החברה בעלת הדוח הכספי'"
              [filterType]="'text'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'reportType'" [displayName]="'סוג דוח (סולו או מאוחד)'"
              [filterType]="'integer'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'endDate'" [displayName]="'תאריך דוח כספי (שנתי בלבד)'" [filterType]="'text'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalBalanceSheet'" [displayName]="'סך המאזן'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'financialDebt'" [displayName]="'חוב פיננסי'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalLeaseLiabilities'" [displayName]="'סך התחייבויות חכירה'"
              [filterType]="'numeric'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'negativeEquity'" [displayName]="'הון (גרעון) עצמי'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'cashAndCashEquivalents'" [displayName]="'מזומנים ושווי מזומנים'"
              [filterType]="'numeric'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'revenueTurnover'" [displayName]="'מחזור הכנסות'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'capitalMarketFlag'" [displayName]="'שייך לסיווגי שוק ההון'"
              [filterType]="'integer'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalProjectEquity'" [displayName]="'סך ההון העצמי שהושקע בפרויקט ליום'"
              [filterType]="'numeric'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalDebtAdditionalFinancier'"
              [displayName]="'סך החוב אצל מממן נוסף ליום (מדרגה שניה או אחר)'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'totalBalanceSheetRiskDebt'"
              [displayName]="'סך החוב המאזני וחוץ מאזני של הפרויקט ליום'" [filterType]="'numeric'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'ourFinancingShare'" [displayName]="'חלקנו במימון ליום'"
              [filterType]="'numeric'" [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'greenBuilding'" [displayName]="'בניה ירוקה'" [filterType]="'integer'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'remarks'" [displayName]="'הערות'" [filterType]="'text'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
          <th>
            <app-filter-field [fieldName]="'officerName'" [displayName]="'שם רפרנט מזין'" [filterType]="'text'"
              [requestSection]="dataService.request()?.projectConstructionFinancing">
            </app-filter-field>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row>
        <tr>
          <td>
            <p-button icon="pi pi-trash" severity="danger" size="small" [outlined]="true"
              (onClick)="deleteProjectConstructionRow(row)" pTooltip="מחק שורה" tooltipPosition="top">
            </p-button>
          </td>
          <td>{{ row.bank }}</td>
          <td>{{ row.branch }}</td>
          <td>{{ row.accountType }}</td>
          <td>{{ row.account }}</td>
          <td>{{ row.accountName }}</td>
          <td>{{ row.branchClassificationCode }}</td>
          <td>{{ row.branchClassificatonDescription }}</td>
          <td>{{ row.creditReportDescription }}</td>
          <td>{{ row.currentCreditAuthority}}</td>
          <td>{{ row.handlingUnitCode }}</td>
          <td>{{ row.regualatedSectorDescription }}</td>
          <td>{{ row.creditBalanceSheetRisk }}</td>
          <td>{{ row.creditOffBalanceSheetRisk }}</td>
          <td>{{ row.totalCreditRisk }}</td>
          <td>{{ row.companyType }}</td>
          <td>{{ row.companyNumber }}</td>
          <td>{{ row.companyName }}</td>
          <td>{{ row.reportType }}</td>
          <td>{{ row.endDate }}</td>
          <td>{{ row.totalBalanceSheet }}</td>
          <td>{{ row.financialDebt }}</td>
          <td>{{ row.totalLeaseLiabilities }}</td>
          <td>{{ row.negativeEquity }}</td>
          <td>{{ row.cashAndCashEquivalents }}</td>
          <td>{{ row.revenueTurnover }}</td>
          <td>{{ row.capitalMarketFlag }}</td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <p-inputnumber [(ngModel)]="row.totalProjectEquity" mode="decimal" [minFractionDigits]="0"
                  [maxFractionDigits]="5" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <p-inputnumber [(ngModel)]="row.totalDebtAdditionalFinancier" mode="decimal" [minFractionDigits]="0"
                  [maxFractionDigits]="5" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <p-inputnumber [(ngModel)]="row.totalBalanceSheetRiskDebt" mode="decimal" [minFractionDigits]="0"
                  [maxFractionDigits]="5" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <p-inputnumber [(ngModel)]="row.ourFinancingShare" mode="decimal" [minFractionDigits]="0"
                  [maxFractionDigits]="5" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <p-inputnumber [(ngModel)]="row.greenBuilding" mode="decimal" [minFractionDigits]="0"
                  [maxFractionDigits]="5" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <textarea rows="1" cols="30" pTextarea [(ngModel)]="row.remarks"
                  (ngModelChange)="onValueChanged(row)"></textarea>
              </ng-template>
            </p-cellEditor>
          </td>
          <td>
            <p-cellEditor>
              <ng-template #output>
                <input type="text" pInputText [(ngModel)]="row.officerName" (ngModelChange)="onValueChanged(row)" />
              </ng-template>
            </p-cellEditor>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="34" class="text-center">
            <div class="empty-message">
              <i class="pi pi-info-circle"></i>
              <p>לא נמצאו נתונים להצגה</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-panel>


  



</div>