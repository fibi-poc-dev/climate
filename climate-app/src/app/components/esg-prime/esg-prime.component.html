<div class="esg-prime-container" dir="rtl">

    <!-- Loading State -->
    @if (isLoading()) {
    <p-card>
        <div class="loading-container">
            <p-progressBar mode="indeterminate"></p-progressBar>
            <p>טוען נתונים...</p>
        </div>
    </p-card>
    }

    <!-- Main Content -->
    @if (!isLoading() && climateData()) {

    <!-- Filters and Actions Toolbar -->
    <p-toolbar>
        <div class="p-toolbar-group-start">
            <p-button label="נקה מסננים" icon="pi pi-filter-slash" severity="secondary" size="small"
                (onClick)="clearFilters()">
            </p-button>
            <p-button label="יצא לקובץ" icon="pi pi-download" severity="info" size="small" (onClick)="exportData()">
            </p-button>
            @if (selectedRow()) {
            <p-button label="נקה בחירה" icon="pi pi-times" severity="danger" size="small" (onClick)="clearSelection()">
            </p-button>
            }
        </div>
        <div class="p-toolbar-group-end">
            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input type="text" pInputText placeholder="חיפוש..." [value]="filterText()"
                    (input)="filterText.set($any($event.target).value)">
            </span>
        </div>
    </p-toolbar>

    <!-- Main Layout Container -->
    <div class="main-layout">

        <!-- Table Section -->
        <div class="table-section">
            <p-card header="נתוני דוח ESG ראשי">
                <p-table id="masterESG" [value]="filteredData()" [paginator]="true" [rows]="10"
                    [rowsPerPageOptions]="[10, 25, 50]" [scrollable]="true" scrollDirection="horizontal"
                    styleClass="p-datatable-striped p-datatable-sm" selectionMode="single"
                    (onRowSelect)="onRowSelect($event)">

                    <ng-template pTemplate="header">
                        <tr>
                            <th pSortableColumn="bank">
                                בנק
                                <p-sortIcon field="bank"></p-sortIcon>
                            </th>
                            <th pSortableColumn="branch">
                                סניף
                                <p-sortIcon field="branch"></p-sortIcon>
                            </th>
                            <th pSortableColumn="account">
                                חשבון
                                <p-sortIcon field="account"></p-sortIcon>
                            </th>
                            <th pSortableColumn="accountName">
                                שם לקוח <p-sortIcon field="accountName"></p-sortIcon>
                            </th>
                            <th pSortableColumn="customerRating">
                                דירוג לקוח
                                <p-sortIcon field="customerRating"></p-sortIcon>
                            </th>
                            <th pSortableColumn="currentCreditAuthority">
                                סמכות אשראי נוכחי
                                <p-sortIcon field="currentCreditAuthority"></p-sortIcon>
                            </th>
                            <th pSortableColumn="handlingUnitCode">
                                יחידה מטפלת
                                <p-sortIcon field="handlingUnitCode"></p-sortIcon>
                            </th>
                            <th pSortableColumn="regualatedSectorCode">
                                קוד מגזר פיקוחי
                                <p-sortIcon field="regualatedSectorCode"></p-sortIcon>
                            </th>
                            <th pSortableColumn="regualatedSectorDescription">
                                תיאור מגזר פיקוחי
                                <p-sortIcon field="regualatedSectorDescription"></p-sortIcon>
                            </th>
                            <th pSortableColumn="branchClassificatonCode">
                                קוד סיווג ענפי
                                <p-sortIcon field="branchClassificatonCode"></p-sortIcon>
                            </th>
                            <th pSortableColumn="branchClassificatonDescription">
                                תיאור סיווג ענפי
                                <p-sortIcon field="branchClassificatonDescription"></p-sortIcon>
                            </th>
                            <th pSortableColumn="subClassificationDescription">
                                קוד תת סיווג ענפי <p-sortIcon field="subClassificationDescription"></p-sortIcon>
                            </th>
                            <th pSortableColumn="subbranchClassificationDescription">
                                תיאור תת סיווג ענפי <p-sortIcon field="subbranchClassificationDescription"></p-sortIcon>
                            </th>
                            <th pSortableColumn="creditReportDescription">
                                תיאור בדוח האשראי <p-sortIcon field="creditReportDescription"></p-sortIcon>
                            </th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-row>
                        <tr [class.selected-row]="selectedRow() === row" (click)="selectRow(row)">
                            <td>{{ row.bank }}</td>
                            <td>{{ row.branch }}</td>
                            <td>{{ row.account }}</td>
                            <td>{{ row.accountName || 'לא ידוע' }}</td>
                            <td>
                                <p-tag [value]="getCustomerRatingLabel(row.customerRating)" severity="info">
                                </p-tag>
                            </td>
                            <td>{{ formatCurrency(row.currentCreditAuthority) }}</td>
                            <td>{{ row.handlingUnitCode || 'לא ידוע' }}</td>
                            <td>{{ row.regualatedSectorCode || 'לא ידוע' }}</td>
                            <td>{{ row.regualatedSectorDescription || 'לא ידוע' }}</td>
                            <td>{{ row.branchClassificatonCode || 'לא ידוע' }}</td>
                            <td>{{ row.branchClassificatonDescription || 'לא ידוע' }}</td>
                            <td>{{ row.subbranchClassificationCode || 'לא ידוע' }}</td>
                            <td>{{ row.subbranchClassificationDescription || 'לא ידוע' }}</td>
                            <td>{{ row.creditReportDescription || 'לא ידוע' }}</td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="14" class="text-center">
                                <div class="empty-message">
                                    <i class="pi pi-info-circle"></i>
                                    <p>לא נמצאו נתונים להצגה</p>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>


        <!-- Details Panel -->
        <div class="details-panel">
            @if (selectedRow()) {
            <p-panel header="{{selectedRow()?.accountName}}">
                <div class="detail-sections-horizontal">
                    <!-- Left Column - Risk and Physical Information -->
                    <div class="detail-column">
                        <h4 class="column-title">מידע על סיכונים</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>קלאסטר אשראי אדום:</label>
                                <span>{{ formatNumber(selectedRow()?.creditRedCluster) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סיכון פיזי שורשי:</label>
                                <span>{{ formatNumber(selectedRow()?.rootPhysicalRisk) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סיכון מעבר שורשי:</label>
                                <span>{{ formatNumber(selectedRow()?.rootTransferRisk) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>משקל סיכון פיזי שורשי:</label>
                                <span>{{ formatNumber(selectedRow()?.rootPhysicalRiskScale) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>משקל סיכון מעבר שורשי:</label>
                                <span>{{ formatNumber(selectedRow()?.rootTransferRiskScale) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>שקלול רמת הסיכון השורשי:</label>
                                <span>{{ formatNumber(selectedRow()?.rootRiskLevelWeight) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סיכון שיורי:</label>
                                <span>{{ formatNumber(selectedRow()?.residualRisk) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>תאריך תוקף סיכון שיורי:</label>
                                <span>{{ formatDate(selectedRow()?.residualRiskDate) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Financial and Classification Information -->
                    <div class="detail-column">
                        <h4 class="column-title">מידע פיננסי וסיווג</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>איכות ניהול:</label>
                                <span>{{ formatNumber(selectedRow()?.qualityManagement) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>קלאסטר שחור:</label>
                                <span>{{ formatNumber(selectedRow()?.blackCluster) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>קלאסטר ירוק:</label>
                                <span>{{ formatNumber(selectedRow()?.greenCluster) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>צבע אקלים:</label>
                                <p-tag [value]="getClimateColorLabel(selectedRow()?.climateColor)"
                                    [severity]="getClimateColorSeverity(selectedRow()?.climateColor)">
                                </p-tag>
                            </div>
                            <div class="detail-item">
                                <label>סך בטחונות:</label>
                                <span>{{ formatCurrency(selectedRow()?.totalCollateral) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סך סולו:</label>
                                <div class="editable-field" [class.editing]="getField('totalSolo')?.isEditing">

                                    <!-- Display Mode -->
                                    <div *ngIf="!getField('totalSolo')?.isEditing" class="display-mode">
                                        <div class="value-container">
                                            <div class="current-value-row">
                                                <span class="current-value"
                                                    [class.modified]="getField('totalSolo')?.isDirty">
                                                    {{ formatCurrency(getEditableValue('totalSolo',
                                                    selectedRow()?.totalSolo)) }}
                                                </span>
                                                <button class="edit-btn"
                                                    (click)="startEdit('totalSolo', selectedRow()?.totalSolo)">
                                                    ✏️
                                                </button>
                                            </div>
                                            <div *ngIf="getField('totalSolo')?.isDirty" class="original-value-row">
                                                <span class="original-indicator">
                                                    מקורי: {{
                                                    formatHebrewNumberSafe(getField('totalSolo')?.originalValue) }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Mode -->
                                    <div *ngIf="getField('totalSolo')?.isEditing" class="edit-mode">
                                        <input type="text" class="edit-input"
                                            [value]="getFormattedFieldValue('totalSolo')"
                                            (input)="onNumberInput($event, 'totalSolo')"
                                            (keypress)="onNumberKeypress($event)" placeholder="הזן ערך חדש">

                                        <div class="original-value-hint">
                                            <span class="info-icon">ℹ️</span>
                                            <span>ערך מקורי: {{
                                                formatHebrewNumberSafe(getField('totalSolo')?.originalValue) }}</span>
                                        </div>

                                        <div class="edit-actions">
                                            <button class="action-btn save" (click)="saveEdit('totalSolo')">
                                                ✓
                                            </button>
                                            <button class="action-btn cancel" (click)="cancelEdit('totalSolo')">
                                                ✕
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="detail-item">
                                <label>סיכון אשראי מאזני:</label>
                                <span>{{ formatCurrency(selectedRow()?.creditBalanceSheetRisk) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סיכון אשראי חוץ מאזני:</label>
                                <span>{{ formatCurrency(selectedRow()?.creditOffBalanceSheetRisk) }}</span>
                            </div>
                            <div class="detail-item">
                                <label>סה"כ סיכון אשראי:</label>
                                <span>{{ formatCurrency(selectedRow()?.totalCreditRisk) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </p-panel>

            } @else {
            <p-panel header="פרטי השורה">
                <div class="no-selection">
                    <i class="pi pi-info-circle"></i>
                    <p>בחר שורה מהטבלה כדי לראות פרטים</p>
                </div>
            </p-panel>
            }
        </div>
    </div>
    }

    <!-- No Data State -->
    @if (!isLoading() && !climateData()) {
    <p-card>
        <div class="no-data-container">
            <i class="pi pi-exclamation-triangle"></i>
            <h3>אין נתונים זמינים</h3>
            <p>לא נמצאו נתוני ESG להצגה</p>
        </div>
    </p-card>
    }

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top-btn" (click)="scrollToTop()" [class.visible]="showScrollToTop()" pTooltip="חזור למעלה"
        tooltipPosition="left">
        <i class="pi pi-angle-up"></i>
    </button>
</div>