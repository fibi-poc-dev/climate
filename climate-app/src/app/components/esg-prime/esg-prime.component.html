<div class="esg-prime-container" dir="rtl">
    <!-- Loading State -->
    @if (isLoading()) {
    <p-card>
        <div class="loading-container">
            <p-progressBar mode="indeterminate"></p-progressBar>
            <p>טוען נתונים...</p>
        </div>
    </p-card>
    }
    <!-- Main Content -->
    @if (!isLoading() && climateData()) {
    <!-- Filters and Actions Toolbar -->
    <p-toolbar>
        <div class="p-toolbar-group-start">
            <p-button label="נקה מסננים" icon="pi pi-filter-slash" severity="secondary" size="small"
                (onClick)="clearFilters()">
            </p-button>
            <p-button label="יצא לקובץ" icon="pi pi-download" severity="info" size="small" (onClick)="exportData()">
            </p-button>
            @if (esgRequestFilters().length > 0) {
            <p-button label="שלח מסננים לשרת" icon="pi pi-send" severity="success" size="small"
                (onClick)="sendFiltersToServer()">
            </p-button>
            }
            @if (selectedRow()) {
            <p-button label="נקה בחירה" icon="pi pi-times" severity="danger" size="small" (onClick)="clearSelection()">
            </p-button>
            }
        </div>
        <div class="p-toolbar-group-end">
            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input type="text" pInputText placeholder="חיפוש..." [value]="filterText()"
                    (input)="filterText.set($any($event.target).value)">
            </span>
        </div>
    </p-toolbar>

    <!-- Debug Display for Active Filters -->
    @if (esgRequestFilters().length > 0) {
    <p-card header="מסננים פעילים" styleClass="active-filters-panel">
        <div class="active-filters-container">
            @for (filter of esgRequestFilters(); track filter.filterFieldName) {
            <div class="filter-chip">
                <span class="filter-label">{{ getFilterDisplayName(filter.filterFieldName) }}:</span>
                <span class="filter-value">{{ filter.filterFieldValue }}</span>
                <span class="filter-operator">({{ getOperatorSymbol(filter.filterType) }})</span>
                <button class="remove-filter-btn" (click)="removeFilter(filter.filterFieldName)"
                    title="הסר מסנן">✕</button>
            </div>
            }
        </div>
    </p-card>
    }
    <!-- Main Layout Container -->
    <div class="main-layout">
        <!-- Table Section -->
        <div class="table-section">
            <p-card [class.selected-card]="selectedRow() !== null">
                <p-table id="masterESG" [value]="filteredData()" [paginator]="true" [rows]="10"
                    [rowsPerPageOptions]="[10, 25, 50]" [scrollable]="true" scrollDirection="both"
                    scrollHeight="calc(100vh - 250px)" styleClass="p-datatable-striped p-datatable-sm"
                    selectionMode="single" (onRowSelect)="onRowSelect($event)">

                    <ng-template pTemplate="header">
                        <tr>
                            <th>בנק</th>
                            <th>סניף</th>
                            <th>חשבון</th>
                            <th>שם לקוח</th>
                            <th>דירוג לקוח</th>
                            <th>סמכות אשראי נוכחי</th>
                            <th>יחידה מטפלת</th>
                            <th>קוד מגזר פיקוחי</th>
                            <th>תיאור מגזר פיקוחי</th>
                            <th>קוד סיווג ענפי</th>
                            <th>תיאור סיווג ענפי</th>
                            <th>קוד תת סיווג ענפי</th>
                            <th>תיאור תת סיווג ענפי</th>
                            <th>תיאור בדוח האשראי</th>
                            <th>סך בטחונות</th>
                            <th>סך סולו</th>
                            <th>סך סיכון אשראי באש"ח ללא משכנתאות</th>
                        </tr>
                        <tr>
                            <th>
                                <!-- Bank Filter - Text Only -->
                                <input type="text" pInputText [placeholder]="getFilterPlaceholder('bank')"
                                    [value]="getFilterValue('bank')"
                                    (input)="updateFilterValue('bank', $any($event.target).value)"
                                    class="filter-input">
                            </th>
                            <th>
                                <!-- Branch Filter - Text Only -->
                                <input type="text" pInputText [placeholder]="getFilterPlaceholder('branch')"
                                    [value]="getFilterValue('branch')"
                                    (input)="updateFilterValue('branch', $any($event.target).value)"
                                    class="filter-input">
                            </th>
                            <th>
                                <!-- Account Filter - Text Only -->
                                <input type="text" pInputText [placeholder]="getFilterPlaceholder('account')"
                                    [value]="getFilterValue('account')"
                                    (input)="updateFilterValue('account', $any($event.target).value)"
                                    class="filter-input">
                            </th>
                            <th>
                                <!-- Account Name Filter - Text Only -->
                                <input type="text" pInputText [placeholder]="getFilterPlaceholder('accountName')"
                                    [value]="getFilterValue('accountName')"
                                    (input)="updateFilterValue('accountName', $any($event.target).value)"
                                    class="filter-input">
                            </th>
                            <th>
                                <!-- Customer Rating Filter - Numeric with Operator -->
                                <div class="filter-controls">
                                    <input type="text" pInputText
                                        [placeholder]="getFilterPlaceholder('customerRating')"
                                        [value]="getFilterValue('customerRating')"
                                        (input)="updateFilterValue('customerRating', $any($event.target).value)"
                                        class="filter-input filter-amount">
                                    <select [value]="getFilterOperatorDisplay('customerRating')"
                                        (change)="onCustomerRatingFilterTypeChange($any($event.target).value)"
                                        class="filter-type-select">
                                        <option value="=">=</option>
                                        <option value="gt">&gt;</option>
                                        <option value="lt">&lt;</option>
                                        <option value="gte">&gt;=</option>
                                        <option value="lte">&lt;=</option>
                                    </select>
                                </div>
                            </th>
                            <th>
                                <!-- Current Credit Authority Filter - Numeric with Operator -->
                                <div class="filter-controls">
                                    <input type="text" pInputText
                                        [placeholder]="getFilterPlaceholder('currentCreditAuthority')"
                                        [value]="getFilterValue('currentCreditAuthority')"
                                        (input)="updateFilterValue('currentCreditAuthority', $any($event.target).value)"
                                        class="filter-input filter-amount">
                                    <select [value]="getFilterOperatorDisplay('currentCreditAuthority')"
                                        (change)="onCurrentCreditAuthorityFilterTypeChange($any($event.target).value)"
                                        class="filter-type-select">
                                        <option value="=">=</option>
                                        <option value="gt">&gt;</option>
                                        <option value="lt">&lt;</option>
                                        <option value="gte">&gt;=</option>
                                        <option value="lte">&lt;=</option>
                                    </select>
                                </div>
                            </th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th>
                                <!-- Total Solo Filter - Numeric with Operator -->
                                <div class="filter-controls">
                                    <input type="text" pInputText [placeholder]="getFilterPlaceholder('totalSolo')"
                                        [value]="getFilterValue('totalSolo')"
                                        (input)="updateFilterValue('totalSolo', $any($event.target).value)"
                                        class="filter-input filter-amount">
                                    <select [value]="getFilterOperatorDisplay('totalSolo')"
                                        (change)="onTotalSoloFilterTypeChange($any($event.target).value)"
                                        class="filter-type-select">
                                        <option value="=">=</option>
                                        <option value="gt">&gt;</option>
                                        <option value="lt">&lt;</option>
                                        <option value="gte">&gt;=</option>
                                        <option value="lte">&lt;=</option>
                                    </select>
                                </div>
                            </th>
                            <th></th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-row>
                        <tr [class.selected-row]="selectedRow() === row" (click)="selectRow(row)">
                            <td>{{ row.bank }}</td>
                            <td>{{ row.branch }}</td>
                            <td>{{ row.account }}</td>
                            <td>{{ row.accountName || '' }}</td>
                            <td>{{ row.customerRating }}</td>
                            <!-- <td>
                                <p-tag [value]="getCustomerRatingLabel(row.customerRating)" severity="info">
                                </p-tag>
                            </td> -->
                            <td>{{ formatCurrency(row.currentCreditAuthority) }}</td>
                            <td>{{ row.handlingUnitCode || '' }}</td>
                            <td>{{ row.regualatedSectorCode || '' }}</td>
                            <td>{{ row.regualatedSectorDescription || '' }}</td>
                            <td>{{ row.branchClassificatonCode || '' }}</td>
                            <td>{{ row.branchClassificatonDescription || '' }}</td>
                            <td>{{ row.subbranchClassificationCode || '' }}</td>
                            <td>{{ row.subbranchClassificationDescription || '' }}</td>
                            <td>{{ row.creditReportDescription || '' }}</td>
                            <td>{{ formatCurrency(row.totalCollateral) }}</td>
                            <td>{{ formatCurrency(row.totalSolo) }}</td>
                            <td>{{ formatCurrency(row.totalCreditRisk) }}</td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="14" class="text-center">
                                <div class="empty-message">
                                    <i class="pi pi-info-circle"></i>
                                    <p>לא נמצאו נתונים להצגה</p>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>


        <!-- Details Panel -->
        <div class="details-panel">
            @if (selectedRow()) {                
            <p-panel header="{{selectedRow()?.accountName}}">
                <div class="detail-sections-horizontal">
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>קלאסטר אשראי אדום:</label>
                            <app-editable-field
                                [value]="selectedRow()?.creditRedCluster ?? null"
                                [fieldName]="'creditRedCluster'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('creditRedCluster', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סיכון פיזי שורשי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.rootPhysicalRisk ?? null"
                                [fieldName]="'rootPhysicalRisk'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('rootPhysicalRisk', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סיכון מעבר שורשי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.rootTransferRisk ?? null"
                                [fieldName]="'rootTransferRisk'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('rootTransferRisk', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>משקל סיכון פיזי שורשי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.rootPhysicalRiskScale ?? null"
                                [fieldName]="'rootPhysicalRiskScale'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('rootPhysicalRiskScale', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>משקל סיכון מעבר שורשי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.rootTransferRiskScale ?? null"
                                [fieldName]="'rootTransferRiskScale'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('rootTransferRiskScale', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>שקלול רמת הסיכון השורשי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.rootRiskLevelWeight ?? null"
                                [fieldName]="'rootRiskLevelWeight'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('rootRiskLevelWeight', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סיכון שיורי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.residualRisk ?? null"
                                [fieldName]="'residualRisk'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('residualRisk', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>תאריך תוקף סיכון שיורי:</label>
                            <span>{{ formatDate(selectedRow()?.residualRiskDate) }}</span>
                        </div>
                        <div class="detail-item">
                            <label>איכות ניהול:</label>
                            <app-editable-field
                                [value]="selectedRow()?.qualityManagement ?? null"
                                [fieldName]="'qualityManagement'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('qualityManagement', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>קלאסטר שחור:</label>
                            <app-editable-field
                                [value]="selectedRow()?.blackCluster ?? null"
                                [fieldName]="'blackCluster'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('blackCluster', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>קלאסטר ירוק:</label>
                            <app-editable-field
                                [value]="selectedRow()?.greenCluster ?? null"
                                [fieldName]="'greenCluster'"
                                [fieldType]="'number'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('greenCluster', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>צבע אקלים:</label>
                            <p-tag [value]="getClimateColorLabel(selectedRow()?.climateColor)"
                                [severity]="getClimateColorSeverity(selectedRow()?.climateColor)">
                            </p-tag>
                        </div>
                        <div class="detail-item">
                            <label>סך בטחונות:</label>
                            <app-editable-field
                                [value]="selectedRow()?.totalCollateral ?? null"
                                [fieldName]="'totalCollateral'"
                                [fieldType]="'currency'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('totalCollateral', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סך סולו:</label>
                            <app-editable-field
                                [value]="selectedRow()?.totalSolo ?? null"
                                [fieldName]="'totalSolo'"
                                [fieldType]="'currency'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('totalSolo', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סיכון אשראי חוץ מאזני:</label>
                            <app-editable-field
                                [value]="selectedRow()?.creditOffBalanceSheetRisk ?? null"
                                [fieldName]="'creditOffBalanceSheetRisk'"
                                [fieldType]="'currency'"
                                [enableFilter]="true"
                                (valueChange)="onFieldValueChange('creditOffBalanceSheetRisk', $event)"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                        <div class="detail-item">
                            <label>סה"כ סיכון אשראי:</label>
                            <app-editable-field
                                [value]="selectedRow()?.totalCreditRisk ?? null"
                                [fieldName]="'totalCreditRisk'"
                                [fieldType]="'currency'"
                                [enableFilter]="true"
                                [disabled]="true"
                                (filterChange)="onFieldFilterChange($event)">
                            </app-editable-field>
                        </div>
                    </div>
                </div>
            </p-panel>

        } @else {
            <p-panel header="פרטי השורה">
                <div class="no-selection">
                    <i class="pi pi-info-circle"></i>
                    <p>בחר שורה מהטבלה כדי לראות פרטים</p>
                </div>
            </p-panel>
        }
        </div>
    </div>
    }

    <!-- No Data State -->
    @if (!isLoading() && !climateData()) {
    <p-card>
        <div class="no-data-container">
            <i class="pi pi-exclamation-triangle"></i>
            <h3>אין נתונים זמינים</h3>
            <p>לא נמצאו נתוני ESG להצגה</p>
        </div>
    </p-card>
    }

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top-btn" (click)="scrollToTop()" [class.visible]="showScrollToTop()" pTooltip="חזור למעלה"
        tooltipPosition="left">
        <i class="pi pi-angle-up"></i>
    </button>
</div>